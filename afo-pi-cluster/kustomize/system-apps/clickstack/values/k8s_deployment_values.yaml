# deployment.yaml
mode: deployment

image:
  repository: otel/opentelemetry-collector-contrib
  tag: 0.123.0

replicaCount: 1

# Presets disabled - configuring manually to avoid invalid 'otel_annotations' key
# presets:
#   kubernetesAttributes:
#     enabled: true
#     extractAllPodLabels: true
#     extractAllPodAnnotations: true
#   kubernetesEvents:
#     enabled: true
#   clusterMetrics:
#     enabled: true

extraEnvs:
  - name: HYPERDX_API_KEY
    valueFrom:
      secretKeyRef:
        name: hyperdx-secret
        key: HYPERDX_API_KEY
        optional: true
  - name: OTEL_COLLECTOR_ENDPOINT
    valueFrom:
      configMapKeyRef:
        name: otel-config-vars
        key: OTEL_COLLECTOR_ENDPOINT

config:
  receivers:
    k8sobjects:
      objects:
        - name: events
          mode: pull
          label_selector: ""
          field_selector: ""
          interval: 10s

    k8s_cluster:
      collection_interval: 10s
      auth_type: serviceAccount

    prometheus:
      config:
        scrape_configs:
          - job_name: kube-state-metrics
            static_configs:
              - targets: ['kube-state-metrics.observability.svc:8080']
            scrape_interval: 30s

  processors:
    memory_limiter:
      check_interval: 1s
      limit_mib: 200
      spike_limit_mib: 40

    batch:
      send_batch_size: 512
      send_batch_max_size: 1024
      timeout: 10s

    k8sattributes:
      auth_type: serviceAccount
      passthrough: false
      extract:
        metadata:
          - k8s.pod.name
          - k8s.pod.uid
          - k8s.namespace.name
          - k8s.node.name
        labels:
          - tag_name: app.label.component
            key: app.kubernetes.io/component
            from: pod
      pod_association:
        - sources:
            - from: resource_attribute
              name: k8s.pod.ip
        - sources:
            - from: resource_attribute
              name: k8s.pod.uid

  exporters:
    otlphttp:
      endpoint: "${env:OTEL_COLLECTOR_ENDPOINT}"
      compression: gzip
      headers:
        authorization: "${env:HYPERDX_API_KEY}"

  service:
    pipelines:
      logs:
        receivers:
          - k8sobjects
        processors:
          - memory_limiter
          - k8sattributes
          - batch
        exporters:
          - otlphttp
      metrics:
        receivers:
          - k8s_cluster
          - prometheus
        processors:
          - memory_limiter
          - k8sattributes
          - batch
        exporters:
          - otlphttp
