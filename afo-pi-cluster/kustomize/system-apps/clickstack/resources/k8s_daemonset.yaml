# daemonset.yaml
mode: daemonset

image:
  repository: otel/opentelemetry-collector-contrib
  tag: 0.123.0

# Required to use the kubeletstats cpu/memory utilization metrics
clusterRole:
  create: true
  rules:
    - apiGroups:
        - ""
      resources:
        - nodes/proxy
      verbs:
        - get

# Presets disabled - configuring manually to avoid invalid 'otel_annotations' key
# presets:
#   logsCollection:
#     enabled: true
#   hostMetrics:
#     enabled: true
#   kubeletMetrics:
#     enabled: true

extraEnvs:
  - name: HYPERDX_API_KEY
    valueFrom:
      secretKeyRef:
        name: hyperdx-secret
        key: HYPERDX_API_KEY
        optional: true
  - name: OTEL_COLLECTOR_ENDPOINT
    valueFrom:
      configMapKeyRef:
        name: otel-config-vars
        key: OTEL_COLLECTOR_ENDPOINT
  - name: K8S_NODE_NAME
    valueFrom:
      fieldRef:
        fieldPath: spec.nodeName

config:
  receivers:
    filelog:
      include:
        - /var/log/pods/*/*/*.log
      include_file_path: true
      start_at: end
      operators:
        - id: container-parser
          type: container

    hostmetrics:
      collection_interval: 30s
      scrapers:
        cpu: {}
        memory: {}
        disk: {}
        filesystem: {}
        network: {}

    # Configures kubelet metrics
    kubeletstats:
      collection_interval: 20s
      auth_type: "serviceAccount"
      endpoint: "https://${env:K8S_NODE_NAME}:10250"
      insecure_skip_verify: true
      # Note: kubeletstats automatically collects all available metrics from kubelet API,
      # including: k8s.pod.cpu_limit_utilization, k8s.pod.cpu_request_utilization,
      # k8s.pod.memory_limit_utilization, k8s.pod.memory_request_utilization, k8s.pod.uptime,
      # k8s.node.uptime, k8s.container.cpu_limit_utilization, k8s.container.cpu_request_utilization,
      # k8s.container.memory_limit_utilization, k8s.container.memory_request_utilization,
      # container.uptime, and many others. No metrics configuration needed.

  processors:
    memory_limiter:
      check_interval: 1s
      limit_mib: 200
      spike_limit_mib: 40

    batch:
      send_batch_size: 512
      send_batch_max_size: 1024
      timeout: 10s

    k8sattributes:
      auth_type: serviceAccount
      passthrough: false
      extract:
        metadata:
          - k8s.pod.name
          - k8s.pod.uid
          - k8s.namespace.name
          - k8s.node.name
        labels:
          - tag_name: app.label.component
            key: app.kubernetes.io/component
            from: pod
      pod_association:
        - sources:
            - from: resource_attribute
              name: k8s.pod.ip
        - sources:
            - from: resource_attribute
              name: k8s.pod.uid

  exporters:
    otlphttp:
      endpoint: "${env:OTEL_COLLECTOR_ENDPOINT}"
      compression: gzip
      headers:
        authorization: "${env:HYPERDX_API_KEY}"

  service:
    pipelines:
      logs:
        receivers:
          - filelog
        processors:
          - memory_limiter
          - k8sattributes
          - batch
        exporters:
          - otlphttp
      metrics:
        receivers:
          - hostmetrics
          - kubeletstats
        processors:
          - memory_limiter
          - k8sattributes
          - batch
        exporters:
          - otlphttp
